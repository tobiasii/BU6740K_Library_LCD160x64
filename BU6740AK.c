/**
 * @file BU6740AK.h
 * @author Tobias Salazar (you@domain.com)
 * @brief 	Biblioteca C com intuito de ser generica para qualquer arquitetura de MCU com SPI(Hardware ou Software)
 * 			para comunicação com Painel de Impressora HP com BU6740AK 
 * 			Codigo teve como base a library do site 'http:\\cocus.dx.am\2017\05\04\hp-3550-glcd-hack\'			
 * @version 1.0
 * @date 2020-09-20 
 * 
 * @copyright Copyright (c) 2020
 * 
 */

#include "BU6740AK.h"


unsigned int GLCD_Init[] = { 0xF000,
						 0xF000,
						 0xF30A,
						 0xA000,
						 0x2002,
						 0x60C4,
						 0x2003,
						 0x600B,
						 0x200C,
						 0x6098,
						 0x2000,
						 0x6007,
						 0x2006,
						 0x6023 /* end of init */};

unsigned char System5x7[] =
{
	0x00, 0x00, 0x00, 0x00, 0x00,// (space)
	0x00, 0x00, 0x5F, 0x00, 0x00,// !
	0x00, 0x07, 0x00, 0x07, 0x00,// "
	0x14, 0x7F, 0x14, 0x7F, 0x14,// #
	0x24, 0x2A, 0x7F, 0x2A, 0x12,// $
	0x23, 0x13, 0x08, 0x64, 0x62,// %
	0x36, 0x49, 0x55, 0x22, 0x50,// &
	0x00, 0x05, 0x03, 0x00, 0x00,// '
	0x00, 0x1C, 0x22, 0x41, 0x00,// (
	0x00, 0x41, 0x22, 0x1C, 0x00,// )
	0x08, 0x2A, 0x1C, 0x2A, 0x08,// *
	0x08, 0x08, 0x3E, 0x08, 0x08,// +
	0x00, 0x50, 0x30, 0x00, 0x00,// ,
	0x08, 0x08, 0x08, 0x08, 0x08,// -
	0x00, 0x60, 0x60, 0x00, 0x00,// .
	0x20, 0x10, 0x08, 0x04, 0x02,// /
	0x3E, 0x51, 0x49, 0x45, 0x3E,// 0
	0x00, 0x42, 0x7F, 0x40, 0x00,// 1
	0x42, 0x61, 0x51, 0x49, 0x46,// 2
	0x21, 0x41, 0x45, 0x4B, 0x31,// 3
	0x18, 0x14, 0x12, 0x7F, 0x10,// 4
	0x27, 0x45, 0x45, 0x45, 0x39,// 5
	0x3C, 0x4A, 0x49, 0x49, 0x30,// 6
	0x01, 0x71, 0x09, 0x05, 0x03,// 7
	0x36, 0x49, 0x49, 0x49, 0x36,// 8
	0x06, 0x49, 0x49, 0x29, 0x1E,// 9
	0x00, 0x36, 0x36, 0x00, 0x00,// :
	0x00, 0x56, 0x36, 0x00, 0x00,// ;
	0x00, 0x08, 0x14, 0x22, 0x41,// <
	0x14, 0x14, 0x14, 0x14, 0x14,// =
	0x41, 0x22, 0x14, 0x08, 0x00,// >
	0x02, 0x01, 0x51, 0x09, 0x06,// ?
	0x32, 0x49, 0x79, 0x41, 0x3E,// @
	0x7E, 0x11, 0x11, 0x11, 0x7E,// A
	0x7F, 0x49, 0x49, 0x49, 0x36,// B
	0x3E, 0x41, 0x41, 0x41, 0x22,// C
	0x7F, 0x41, 0x41, 0x22, 0x1C,// D
	0x7F, 0x49, 0x49, 0x49, 0x41,// E
	0x7F, 0x09, 0x09, 0x01, 0x01,// F
	0x3E, 0x41, 0x41, 0x51, 0x32,// G
	0x7F, 0x08, 0x08, 0x08, 0x7F,// H
	0x00, 0x41, 0x7F, 0x41, 0x00,// I
	0x20, 0x40, 0x41, 0x3F, 0x01,// J
	0x7F, 0x08, 0x14, 0x22, 0x41,// K
	0x7F, 0x40, 0x40, 0x40, 0x40,// L
	0x7F, 0x02, 0x04, 0x02, 0x7F,// M
	0x7F, 0x04, 0x08, 0x10, 0x7F,// N
	0x3E, 0x41, 0x41, 0x41, 0x3E,// O
	0x7F, 0x09, 0x09, 0x09, 0x06,// P
	0x3E, 0x41, 0x51, 0x21, 0x5E,// Q
	0x7F, 0x09, 0x19, 0x29, 0x46,// R
	0x46, 0x49, 0x49, 0x49, 0x31,// S
	0x01, 0x01, 0x7F, 0x01, 0x01,// T
	0x3F, 0x40, 0x40, 0x40, 0x3F,// U
	0x1F, 0x20, 0x40, 0x20, 0x1F,// V
	0x7F, 0x20, 0x18, 0x20, 0x7F,// W
	0x63, 0x14, 0x08, 0x14, 0x63,// X
	0x03, 0x04, 0x78, 0x04, 0x03,// Y
	0x61, 0x51, 0x49, 0x45, 0x43,// Z
	0x00, 0x00, 0x7F, 0x41, 0x41,// [
	0x02, 0x04, 0x08, 0x10, 0x20,// "\"
	0x41, 0x41, 0x7F, 0x00, 0x00,// ]
	0x04, 0x02, 0x01, 0x02, 0x04,// ^
	0x40, 0x40, 0x40, 0x40, 0x40,// _
	0x00, 0x01, 0x02, 0x04, 0x00,// `
	0x20, 0x54, 0x54, 0x54, 0x78,// a
	0x7F, 0x48, 0x44, 0x44, 0x38,// b
	0x38, 0x44, 0x44, 0x44, 0x20,// c
	0x38, 0x44, 0x44, 0x48, 0x7F,// d
	0x38, 0x54, 0x54, 0x54, 0x18,// e
	0x08, 0x7E, 0x09, 0x01, 0x02,// f
	0x08, 0x14, 0x54, 0x54, 0x3C,// g
	0x7F, 0x08, 0x04, 0x04, 0x78,// h
	0x00, 0x44, 0x7D, 0x40, 0x00,// i
	0x20, 0x40, 0x44, 0x3D, 0x00,// j
	0x00, 0x7F, 0x10, 0x28, 0x44,// k
	0x00, 0x41, 0x7F, 0x40, 0x00,// l
	0x7C, 0x04, 0x18, 0x04, 0x78,// m
	0x7C, 0x08, 0x04, 0x04, 0x78,// n
	0x38, 0x44, 0x44, 0x44, 0x38,// o
	0x7C, 0x14, 0x14, 0x14, 0x08,// p
	0x08, 0x14, 0x14, 0x18, 0x7C,// q
	0x7C, 0x08, 0x04, 0x04, 0x08,// r
	0x48, 0x54, 0x54, 0x54, 0x20,// s
	0x04, 0x3F, 0x44, 0x40, 0x20,// t
	0x3C, 0x40, 0x40, 0x20, 0x7C,// u
	0x1C, 0x20, 0x40, 0x20, 0x1C,// v
	0x3C, 0x40, 0x30, 0x40, 0x3C,// w
	0x44, 0x28, 0x10, 0x28, 0x44,// x
	0x0C, 0x50, 0x50, 0x50, 0x3C,// y
	0x44, 0x64, 0x54, 0x4C, 0x44,// z
	0x00, 0x08, 0x36, 0x41, 0x00,// {
	0x00, 0x00, 0x7F, 0x00, 0x00,// |
	0x00, 0x41, 0x36, 0x08, 0x00,// }
	0x08, 0x08, 0x2A, 0x1C, 0x08,// ->
	0x08, 0x1C, 0x2A, 0x08, 0x08 // <-
};

unsigned char KeyIcons[] = { 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x08, 0x0C, 0x0E, 0x0F, 0x0E, 0x0C, 0x08, 0x00,		// up 
	0x01, 0x03, 0x07, 0x0F, 0x07, 0x03, 0x01, 0x00,		// down
	0x04, 0x4E, 0x5F, 0x44, 0x44, 0x44, 0x38, 0x00,		// back 
	0x00, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x00,		// menu
	0x1C, 0x22, 0x55, 0x49, 0x55, 0x22, 0x1C, 0x00,		// stop 
	0x08, 0x10, 0x20, 0x10, 0x08, 0x04, 0x02, 0x01,		// tick 
	0x00, 0x06, 0x01, 0xB1, 0x09, 0x06, 0x00, 0x00,		// help
};

int Init(BU6740AK *Painel , unsigned int(*Send16)(unsigned int) , void (*Start)(void) ,void (*Stop)(void) )
{
	if(Painel && Send16 && Start && Stop ){
            int i ;

		Painel->Start = Start ;
		Painel->_Send16 = Send16;
		Painel->Stop = Stop;

		Painel->Start();

		for (i = 0; i < (sizeof(GLCD_Init) / sizeof(GLCD_Init[0])); i ++)
		{
			Painel->_Send16(GLCD_Init[i]);
		}

		Painel->Stop();
	}
	else{
		if(!Painel)
			return 1;
		if(!Send16)
			return 2;
		if(!Start)
			return 3;
		if(!Stop)
			return 4;
	}
}

int GetKey(BU6740AK *Painel)
{	
	unsigned int ret;

	Painel->Start();

	/* It's mandatory to send this, even if we dont care for it's output */
	ret =Painel->_Send16(0xFA00);
	if (ret != 0x4001) return -1;				/* check for communication errors */
	ret =Painel->_Send16(0xF900);
	if ((ret & 0x4A00) != 0x4A00) return -1;	/* check for communication errors */

	/* First group of inputs (0xF8000) */
	ret =Painel->_Send16(0xF800);
	if ((ret & 0x4900) != 0x4900) return -1;	/* check for communication errors */

	Painel->KBState.Help = (ret & 0x01) == 0;
	Painel->KBState.Tick = (ret & 0x02) == 0;
	Painel->KBState.Down = (ret & 0x04) == 0;
	Painel->KBState.Back = (ret & 0x08) == 0;
	Painel->KBState.Up =   (ret & 0x10) == 0;	

	/* Second group of inputs (0xF7000) */
	ret =Painel->_Send16(0xF700);
	if ((ret & 0x4800) != 0x4800) return -1;	/* check for communication errors */

	Painel->KBState.Menu = (ret & 0x80) == 0;
	Painel->KBState.Stop = (ret & 0x40) == 0;

	/* It's mandatory to send this, even if we dont care for it's output */
	Painel->_Send16(0xF600);
	Painel->_Send16(0xF500);
	Painel->_Send16(0xF400);
	Painel->_Send16(0xF300);
	Painel->_Send16(0xF200);
	Painel->_Send16(0xF100);
	Painel->_Send16(0xF000);

	Painel->Stop();
	return  0 ;
}

void SetLeds(BU6740AK *Painel , unsigned char leds)
{
	Painel->Start();
	/* 0x90XX, XX = pins to turn on or off */
	Painel->_Send16(0x9000 | ((leds) << 0));
	Painel->Stop();
}

void SendRows(BU6740AK *Painel , unsigned char row_data[], unsigned char count)
{
	Painel->Start();
	/* Fixed sequence */
	Painel->_Send16(0x2001);
	Painel->_Send16(0x6003);
	Painel->_Send16(0x2004);
	Painel->_Send16(0x6000 | (Painel->current_col));
	Painel->_Send16(0x60C0 | (Painel->current_row));
	Painel->_Send16(0x2007);
	while (count){
		Painel->_Send16(0x6000 | *row_data);
		row_data++;
		count--;
	}
	Painel->Stop();
}

void ClearScreen(BU6740AK *Painel)
{
	unsigned char col;
	unsigned char row;

	Painel->Start();
	
	for (col = 0; col < 20; col++)
	{
		/* Fixed sequence */
		Painel->_Send16(0x2001);
		Painel->_Send16(0x6003);
		Painel->_Send16(0x2004);
		Painel->_Send16(0x6000 | (col));
		Painel->_Send16(0x60C0);
		Painel->_Send16(0x2007);

		for (row = 0; row < 32; row++)
		{
			Painel->_Send16(0x6000); /* null pixels */
		}
	}

	Painel->Stop();
}

void SetColumn(BU6740AK *Painel,unsigned char col){
	if( col < 20 )
		Painel->current_col = col ;
}

void SetRow(BU6740AK *Painel,unsigned char row){
	if( row < 32 )
		Painel->current_row = row ;
}
void PrintText(BU6740AK *Painel ,unsigned char col, unsigned char row, char txt[] , unsigned char length )
{
  unsigned char i ;

	unsigned char rows[7];

	SetRow(Painel,row);

	for (i = 0; i < length ; i++)
	{
		unsigned char bits , sub_bit , row;
		SetColumn(Painel,i + col);

		for ( row = 0; row < 7; row++)
		{
			bits = 0;

			for ( sub_bit = 0; sub_bit < 5; sub_bit++)
			{
				bits |= (System5x7[((txt[i] - ' ') * 5) + sub_bit] & (1 << row)) >> row;
				
				if (sub_bit != 7)
				{
					bits <<= 1;
				}
			}

			rows[row] = bits;
		}

		SendRows(Painel,rows, 7);
	}
}

void PrintIcon(BU6740AK *Painel ,unsigned char col, unsigned char _row, unsigned char icon_id)
{
  unsigned char row , sub_bit;
	unsigned char rows[8];

	SetRow(Painel,_row);

	unsigned char bits;
	SetColumn(Painel,col);

	for (row = 0; row < 8; row++)
	{
		bits = 0;

		for ( sub_bit = 0; sub_bit < 8; sub_bit++)
		{
			bits |= (KeyIcons[(icon_id * 8) + sub_bit] & (1 << row)) >> row;
			
			if (sub_bit != 7)
			{
				bits <<= 1;
			}
		}

		rows[row] = bits;
	}

	SendRows(Painel,rows, 8);
}
